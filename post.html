<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>記事詳細 - ブローグ</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9f9f9;
      color: #333;
      padding: 2rem;
      max-width: 700px;
      margin: auto;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 1rem;
    }
    .meta {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 1.5rem;
    }
    .body {
      font-size: 1rem;
      line-height: 1.8;
    }
  </style>
</head>
<body>
  <h1 id="title">読み込み中...</h1>
  <div class="meta" id="meta"></div>
  <div class="body" id="body"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDZwl7MJrNJD2qU7bkATpZ2DVt0cjLb07s",
      authDomain: "blogue-9c04d.firebaseapp.com",
      projectId: "blogue-9c04d",
      storageBucket: "blogue-9c04d.firebasestorage.app",
      messagingSenderId: "330012087470",
      appId: "1:330012087470:web:afe058423a9bcf98bf493f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const params = new URLSearchParams(location.search);
    const id = params.get("id");

    if (!id) {
      document.getElementById("title").textContent = "記事IDが指定されていません。";
      throw new Error("No ID in URL");
    }

    onAuthStateChanged(auth, async (user) => {
      try {
        const postRef = doc(db, "posts", id);
        const pendingRef = doc(db, "posts_pending", id);

        let postSnap = await getDoc(postRef);
        if (!postSnap.exists()) {
          if (!user) {
            location.href = "/login.html";
            return;
          }
          postSnap = await getDoc(pendingRef);
        }

        if (postSnap.exists()) {
          const data = postSnap.data();
          document.getElementById("title").textContent = data.title;
          document.getElementById("meta").textContent = `投稿者: ${data.author || "匿名"} / タグ: ${data.tags?.join(", ") || "なし"}`;
          document.getElementById("body").innerHTML = data.body;
        } else {
          document.getElementById("title").textContent = "記事が見つかりませんでした。";
        }
      } catch (error) {
        console.error("読み込みエラー:", error);
        document.getElementById("title").textContent = "記事の読み込み中にエラーが発生しました。";
      }
    });
  </script>
</body>
</html>
